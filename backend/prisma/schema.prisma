generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================
enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
  INACTIVE
}

enum OrderStatus {
  PENDING
  ACCEPTED
  PREPARING
  READY
  SERVED
  COMPLETED
  CANCELLED
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  MOMO
  ZALOPAY
  BANK_TRANSFER
  VNPAY
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum MenuStatus {
  ACTIVE
  INACTIVE
}

enum ItemStatus {
  AVAILABLE
  UNAVAILABLE
  SOLDOUT
}

enum ModifierSelectionType {
  SINGLE
  MULTIPLE
}

enum UserRole {
  ADMIN
  STAFF
  WAITER
}

// ========================================
// TABLE MODEL (SIMPLIFIED)
// ========================================
model Table {
  id               String      @id @default(uuid()) @db.Uuid
  tableNumber      String      @unique @map("table_number") @db.VarChar(50)
  capacity         Int
  location         String?     @db.VarChar(100)
  description      String?     @db.Text
  status           TableStatus @default(AVAILABLE)
  qrToken          String?     @unique @map("qr_token") @db.VarChar(500)
  currentSessionId String?     @map("current_session_id") @db.VarChar(100)
  currentOrderId   String?     @unique @map("current_order_id") @db.Uuid
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  currentOrder Order?  @relation("CurrentTableOrder", fields: [currentOrderId], references: [id], onDelete: SetNull)
  orders       Order[] @relation("TableOrders")

  @@index([status])
  @@index([location])
  @@map("tables")
}

// ========================================
// MENU CATEGORY (SIMPLIFIED)
// ========================================
model MenuCategory {
  id           String     @id @default(uuid()) @db.Uuid
  name         String     @unique @db.VarChar(50) // ← Unique globally
  description  String?    @db.Text
  displayOrder Int        @default(0) @map("display_order")
  status       MenuStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  items MenuItem[]

  @@index([status])
  @@index([displayOrder])
  @@map("menu_categories")
}

// ========================================
// MENU ITEM (SIMPLIFIED)
// ========================================
model MenuItem {
  id                String     @id @default(uuid()) @db.Uuid
  categoryId        String     @map("category_id") @db.Uuid
  name              String     @db.VarChar(80)
  description       String?    @db.Text
  price             Decimal    @db.Decimal(12, 2)
  prepTimeMinutes   Int        @default(0) @map("prep_time_minutes")
  status            ItemStatus
  isChefRecommended Boolean    @default(false) @map("is_chef_recommended")
  isDeleted         Boolean    @default(false) @map("is_deleted")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  category       MenuCategory            @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  photos         MenuItemPhoto[]
  modifierGroups MenuItemModifierGroup[]
  orderItems     OrderItem[]

  @@index([categoryId])
  @@index([status])
  @@index([isDeleted])
  @@map("menu_items")
}

model MenuItemPhoto {
  id         String   @id @default(uuid()) @db.Uuid
  menuItemId String   @map("menu_item_id") @db.Uuid
  url        String   @db.Text
  isPrimary  Boolean  @default(false) @map("is_primary")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([menuItemId, isPrimary])
  @@map("menu_item_photos")
}

// ========================================
// MODIFIER MODELS (SIMPLIFIED)
// ========================================
model ModifierGroup {
  id            String                @id @default(uuid()) @db.Uuid
  name          String                @db.VarChar(80)
  selectionType ModifierSelectionType @map("selection_type")
  isRequired    Boolean               @default(false) @map("is_required")
  minSelections Int                   @default(0) @map("min_selections")
  maxSelections Int                   @default(0) @map("max_selections")
  displayOrder  Int                   @default(0) @map("display_order")
  status        MenuStatus            @default(ACTIVE)
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")

  options   ModifierOption[]
  menuItems MenuItemModifierGroup[]

  @@index([status])
  @@index([displayOrder])
  @@map("modifier_groups")
}

model ModifierOption {
  id              String     @id @default(uuid()) @db.Uuid
  groupId         String     @map("group_id") @db.Uuid
  name            String     @db.VarChar(80)
  priceAdjustment Decimal    @default(0) @map("price_adjustment") @db.Decimal(12, 2)
  sortOrder       Int        @default(0) @map("sort_order")
  isAvailable     Boolean    @default(true) @map("is_available")
  status          MenuStatus @default(ACTIVE)
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  group              ModifierGroup       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  orderItemModifiers OrderItemModifier[]

  @@index([groupId, sortOrder])
  @@index([groupId, status])
  @@map("modifier_options")
}

model MenuItemModifierGroup {
  menuItemId String @map("menu_item_id") @db.Uuid
  groupId    String @map("group_id") @db.Uuid

  menuItem MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  group    ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([menuItemId, groupId])
  @@map("menu_item_modifier_groups")
}

// ========================================
// ORDER MODEL (SIMPLIFIED)
// ========================================
model Order {
  id             String      @id @default(uuid()) @db.Uuid
  tableId        String      @map("table_id") @db.Uuid
  sessionId      String?     @map("session_id") @db.VarChar(100)
  orderNumber    String      @unique @db.VarChar(20) // ← Unique globally
  orderDate      DateTime    @db.Date
  status         OrderStatus @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING) @map("payment_status") // PENDING=UNPAID, PAID=PAID
  subtotalAmount Decimal     @default(0) @map("subtotal_amount") @db.Decimal(12, 2)
  taxAmount      Decimal     @default(0) @map("tax_amount") @db.Decimal(12, 2)
  discountAmount Decimal     @default(0) @map("discount_amount") @db.Decimal(12, 2)
  totalAmount    Decimal     @default(0) @map("total_amount") @db.Decimal(12, 2)

  customerName  String? @map("customer_name") @db.VarChar(100)
  phoneNumber   String? @map("phone_number") @db.VarChar(20)
  customerCount Int?    @default(1) @map("customer_count")
  notes         String? @db.Text

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  confirmedAt DateTime? @map("confirmed_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  table        Table       @relation("TableOrders", fields: [tableId], references: [id], onDelete: Restrict)
  currentTable Table?      @relation("CurrentTableOrder")
  items        OrderItem[]
  payments     Payment[]

  @@index([status])
  @@index([paymentStatus])
  @@index([orderDate])
  @@index([tableId, status])
  @@index([sessionId])
  @@index([orderNumber])
  @@map("orders")
}

// ========================================
// ORDER ITEM (SIMPLIFIED)
// ========================================
model OrderItem {
  id             String          @id @default(uuid()) @db.Uuid
  orderId        String          @map("order_id") @db.Uuid
  menuItemId     String          @map("menu_item_id") @db.Uuid
  menuItemName   String          @map("menu_item_name") @db.VarChar(100)
  menuItemPrice  Decimal         @map("menu_item_price") @db.Decimal(12, 2)
  quantity       Int             @default(1)
  unitPrice      Decimal         @map("unit_price") @db.Decimal(12, 2)
  modifiersTotal Decimal         @default(0) @map("modifiers_total") @db.Decimal(12, 2)
  subtotal       Decimal         @db.Decimal(12, 2)
  status         OrderItemStatus @default(PENDING)
  specialRequest String?         @map("special_request") @db.Text

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  preparedAt DateTime? @map("prepared_at")
  servedAt   DateTime? @map("served_at")

  order             Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem          MenuItem            @relation(fields: [menuItemId], references: [id], onDelete: Restrict)
  selectedModifiers OrderItemModifier[]

  @@index([orderId, status])
  @@index([menuItemId])
  @@index([status, createdAt])
  @@map("order_items")
}

model OrderItemModifier {
  id                 String  @id @default(uuid()) @db.Uuid
  orderItemId        String  @map("order_item_id") @db.Uuid
  modifierOptionId   String  @map("modifier_option_id") @db.Uuid
  modifierGroupName  String  @map("modifier_group_name") @db.VarChar(80)
  modifierOptionName String  @map("modifier_option_name") @db.VarChar(80)
  priceAdjustment    Decimal @map("price_adjustment") @db.Decimal(12, 2)

  orderItem      OrderItem      @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierOption ModifierOption @relation(fields: [modifierOptionId], references: [id], onDelete: Restrict)

  @@index([orderItemId])
  @@map("order_item_modifiers")
}

// ========================================
// PAYMENT (SIMPLIFIED)
// ========================================
model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  orderId       String        @map("order_id") @db.Uuid
  amount        Decimal       @db.Decimal(12, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique @map("transaction_id") @db.VarChar(100)
  notes         String?       @db.Text

  createdAt  DateTime  @default(now()) @map("created_at")
  paidAt     DateTime? @map("paid_at")
  refundedAt DateTime? @map("refunded_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, status])
  @@index([createdAt])
  @@index([method, createdAt])
  @@index([transactionId])
  @@map("payments")
}

// ========================================
// USER (SIMPLIFIED)
// ========================================
model User {
  id                  String    @id @default(uuid()) @db.Uuid
  email               String    @unique @db.VarChar(255)
  password            String    @db.VarChar(255)
  name                String?   @db.VarChar(100)
  role                UserRole  @default(STAFF)
  isActive            Boolean   @default(true) @map("is_active")
  lastLoginAt         DateTime? @map("last_login_at")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([email])
  @@index([role])
  @@map("users")
}

